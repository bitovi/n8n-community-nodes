name: Publish

on:
  schedule:
    - cron: '0 * * * *' # Hourly at the top of each hour
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even if n8n version has not changed'
        required: false
        type: boolean
        default: false
      target_tag:
        description: 'Target tag for the Docker image'
        required: false
        type: string
        default: 'latest'

permissions:
  contents: read

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      n8n_version: ${{ steps.check.outputs.n8n_version }}
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Check for newer n8n base image
        id: check
        env:
          MY_IMAGE: bitovi/n8n-community-nodes
        run: |
          # Check if target_tag is a version number for manual workflow dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.target_tag }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Manual workflow dispatch with version tag detected: ${{ github.event.inputs.target_tag }}"
            echo "Using specified version as n8n version."
            echo "n8n_version=${{ github.event.inputs.target_tag }}" >> "$GITHUB_OUTPUT"
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Getting latest n8n version from Docker Hub..."
          
          # Get all tags from Docker Hub API and find the latest semantic version
          latest_official_n8n=$(curl -s "https://registry.hub.docker.com/v2/repositories/n8nio/n8n/tags/?page_size=100" | \
            jq -r '.results[].name' | \
            grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | \
            sort -V | \
            tail -1)

          if [ -z "$latest_official_n8n" ]; then
            echo "::error::Failed to get latest n8n version from Docker Hub. Halting."
            exit 1
          fi

          echo "Latest official n8n version on Docker Hub: $latest_official_n8n"
          echo "n8n_version=${latest_official_n8n}" >> "$GITHUB_OUTPUT"

          echo "Verifying tag '$latest_official_n8n' exists on Docker Hub for n8nio/n8n..."
          if ! docker manifest inspect "n8nio/n8n:${latest_official_n8n}" > /dev/null; then
            echo "::error::Failed to verify Docker Hub image n8nio/n8n:${latest_official_n8n}. Halting."
            exit 1
          fi
          echo "Latest official version '$latest_official_n8n' is confirmed on Docker Hub."

          echo "Attempting to pull our existing image: ${MY_IMAGE}:latest"
          if ! docker pull "${MY_IMAGE}:latest"; then
            echo "Could not pull existing image. Assuming first run. Proceeding to publish."
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          current_base_version=$(docker inspect --format '{{ index .Config.Labels "io.n8n.version.base" }}' "${MY_IMAGE}:latest")
          if [ -z "$current_base_version" ]; then
            echo "Could not determine n8n version from our image's label. Proceeding to publish."
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Current n8n base version in our image: $current_base_version"

          if [ "$latest_official_n8n" != "$current_base_version" ]; then
            echo "A newer official n8n version ($latest_official_n8n) is available. Proceeding to publish."
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "Our current base version ($current_base_version) is up-to-date. Skipping publish jobs."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          fi

  publish-image:
    runs-on: ${{ matrix.runner }}
    needs: [check-version]
    if: github.event.inputs.force_publish == 'true' || needs.check-version.outputs.should_publish == 'true' || github.event_name == 'schedule' || github.event_name == 'release'
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            platform_tag: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            platform_tag: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Extract Docker metadata for tagging
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: bitovi/n8n-community-nodes
          tags: |
            type=raw,value=${{ github.event.inputs.target_tag || 'latest' }}-${{ matrix.platform_tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            type=raw,value=latest-${{ matrix.platform_tag }},enable=${{ github.event_name != 'workflow_dispatch' && github.ref == 'refs/heads/main' }}
            type=raw,value=${{ needs.check-version.outputs.n8n_version }}-${{ matrix.platform_tag }},enable=${{ github.event_name != 'workflow_dispatch' || github.event.inputs.target_tag != needs.check-version.outputs.n8n_version }}
            type=semver,pattern={{version}}-${{ matrix.platform_tag }},enable=${{ github.event_name == 'release' }}
            type=semver,pattern={{major}}.{{minor}}-${{ matrix.platform_tag }},enable=${{ github.event_name == 'release' && !github.event.release.prerelease }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            io.n8n.version.base=${{ needs.check-version.outputs.n8n_version }}
          platforms: ${{ matrix.platform }}
          build-args: |
            N8N_VERSION=${{ needs.check-version.outputs.n8n_version }}
  
  publish-manifest:
    runs-on: ubuntu-latest
    needs: [check-version, publish-image]
    if: github.event.inputs.force_publish == 'true' || needs.check-version.outputs.should_publish == 'true' || github.event_name == 'schedule' || github.event_name == 'release'
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Create and push multi-arch manifest for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          TARGET_TAG="${{ github.event.inputs.target_tag || 'latest' }}"
          docker buildx imagetools create -t bitovi/n8n-community-nodes:${TARGET_TAG} \
            bitovi/n8n-community-nodes:${TARGET_TAG}-amd64 \
            bitovi/n8n-community-nodes:${TARGET_TAG}-arm64
      - name: Create and push multi-arch manifest for scheduled/main builds
        if: github.event_name != 'workflow_dispatch' && github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create -t bitovi/n8n-community-nodes:latest \
            bitovi/n8n-community-nodes:latest-amd64 \
            bitovi/n8n-community-nodes:latest-arm64
          docker buildx imagetools create -t bitovi/n8n-community-nodes:${{ needs.check-version.outputs.n8n_version }} \
            bitovi/n8n-community-nodes:${{ needs.check-version.outputs.n8n_version }}-amd64 \
            bitovi/n8n-community-nodes:${{ needs.check-version.outputs.n8n_version }}-arm64
      - name: Create and push multi-arch manifest for releases
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          docker buildx imagetools create -t bitovi/n8n-community-nodes:${VERSION} \
            bitovi/n8n-community-nodes:${VERSION}-amd64 \
            bitovi/n8n-community-nodes:${VERSION}-arm64
          
          # Extract major.minor if not a prerelease
          if [[ "${{ github.event.release.prerelease }}" != "true" ]]; then
            MAJOR_MINOR=$(echo ${VERSION} | sed -E 's/^([0-9]+\.[0-9]+)\..*/\1/')
            docker buildx imagetools create -t bitovi/n8n-community-nodes:${MAJOR_MINOR} \
              bitovi/n8n-community-nodes:${MAJOR_MINOR}-amd64 \
              bitovi/n8n-community-nodes:${MAJOR_MINOR}-arm64
          fi
